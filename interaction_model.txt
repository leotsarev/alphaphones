Модель взаимодействия - это интерфейс между мобильным/консольным интерфейсом и движком/контентом. Выглядит это так: мобильный интерфейс крутит эвентлуп и изредка дёргает класс движка/контента. Подразумевается, что все такие вызовы отрабатывают мгновенно.
[9:19:24 PM] Vlad Shcherbina: Интерфейс этого класса таков.
[9:20:11 PM] Vlad Shcherbina: Он либо создаётся в дефолтном состоянии, либо десериализуется.
[9:20:36 PM] Vlad Shcherbina: Далее его спрашивают что дальше.
[9:21:04 PM] Vlad Shcherbina: (передавая сколько реального времени прошло с предыдушего такого вызова, если он был)
[9:22:12 PM] Vlad Shcherbina: Он на это возвращает одну из двух херней: либо описание такта (такт - возможно не самый удачный термин), либо описание менюшки.
[9:26:16 PM] Vlad Shcherbina: Описание менюшки - это список опций и таймаут (ну и возможно какие-то дополнительные данные, нужные для декоративных целей - например, должна ли менюшка постоянным писком ебать тебе мозг).
[9:27:27 PM] Vlad Shcherbina: Вывод сообщения, требующего подтверждения - это частный случай менюшки (с одной опцией). Т.е. мобильный интерфейс может обрабатывать этот случай особо, но с точки зрения логики он ничем не выделяется.
[9:28:01 PM] Vlad Shcherbina: Единократный писк - это частный случай менюшки с нульсекундным таймаутом.
[9:29:07 PM] Vlad Shcherbina: Телефон должен показать менюшку на указанное время. Если выберут какую-то опцию, то классу движка/контента скажут какая опция была выбрана. Если наступит таймаут, то тоже скажут.
[9:29:27 PM] Vlad Shcherbina: После чего опять спросят что дальше.
[9:30:06 PM] Vlad Shcherbina: (в частности, дальше может быть другая ("вложенная") менюшка)
[9:32:00 PM] Vlad Shcherbina: Второй вариант - описание такта. Описание такта - это пара (текст в статусе, желаемая продолжительность такта). Тогда телефон отображает текст статуса (и позволяет начать набирать код в это время) в течение указанного времени. Можно считать, что такт - это такой же интерфейсный элемент ввода, как менюшка, только не для одной опции из фиксированного набора, а для ввода произвольного кода.
[9:32:18 PM] Vlad Shcherbina: Исходом может быть, понятно, либо досрочный ввод кода, либо таймаут.
[9:33:30 PM] Vlad Shcherbina: Ну и об этом исходе точно так же сообщают классу движка/контента, после чего спрашивают что дальше.
[9:33:52 PM] Vlad Shcherbina: Т.е. всё унифицировано до невозможности, я даже несколько опасаюсь, что переборщил с абстракцией тут.
[9:34:31 PM] Vlad Shcherbina: А, да, ещё непосредственно перед вопросом что дальше класс могут спросить, надо ли сохранять его состояние, и если надо, то затребовать его в сериализованном виде.
[9:35:57 PM] Vlad Shcherbina: Ну типа да. Мобильный интерфейс может смотреть, и если опций нет и таймаут нулевой, то даже не рисовать менюшку а просто пищать.
[9:36:47 PM] Vlad Shcherbina: А, да, ещё такой момент. Как определять, какие коды валидные.
[9:38:12 PM] Vlad Shcherbina: Класс движка/контента можно в любой момент спрашивать о статусе любого префикса. Возможные ответы: "валидный код", "поюзанный код", "слишком длинная херня", "прочее (т.е. потенциально префикс валидного кода)".
[9:39:53 PM] Vlad Shcherbina: И ещё мелочь. Если в течение такта пользователь начал вводить код, но не закончил, произошёл таймаут, а следующая херня - это тоже такт (а не менюшка/писк/др.), то недовведённый код остаётся.